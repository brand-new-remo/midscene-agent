# 自然语言模式重构说明

## 概述

本次重构将自然语言模式从指令式格式（`ASSERT:`、`QUERY:`、`SCREENSHOT:`）改为纯粹的自然语言描述，让用户可以直接用自然语言编写自动化任务，由大模型自动判断需要执行什么操作。

## 主要改动

### 1. 执行器修改 (`executor/text_executor.py`)

**修改前：**
- 需要解析特殊指令前缀（`ASSERT:`、`QUERY:`、`SCREENSHOT:`、`WAIT:` 等）
- 根据不同指令执行不同的操作
- 代码复杂，有很多分支逻辑

**修改后：**
- 简化解析逻辑，直接将所有内容作为自然语言传递给 AI
- 所有步骤都通过 AI 自动判断和执行
- 代码更简洁，逻辑更清晰

**核心改动：**
```python
def _parse_step(self, content: str) -> Optional[Dict[str, Any]]:
    """解析单个步骤

    新版本：简化解析逻辑，直接将所有内容作为自然语言传递给 AI
    AI 会自动判断需要执行什么操作
    """
    content = content.strip()

    # 如果内容为空，跳过
    if not content:
        return None

    # 移除旧版本的特殊指令前缀，直接作为自然语言处理
    # 统一格式：所有步骤都使用 ai 动作，让大模型自动判断要做什么
    return {'ai': content}
```

### 2. AI 提示词优化 (`agent/config.py`)

**新增内容：**
- 明确支持自然语言模式
- 说明无需使用特殊指令
- 强调 AI 会自动判断操作类型
- 更详细的能力说明

**关键更新：**
```python
自然语言模式支持：
- 你可以直接理解纯粹的自然语言描述
- 无需使用特殊指令（如 ASSERT:、QUERY:、SCREENSHOT:）
- 用户可以用自然语言描述你想要的操作
- 你会自动判断需要执行什么操作（导航、点击、输入、查询、截图等）
```

### 3. 测试用例更新 (`texts/*.txt`)

**修改前示例：**
```
3. ASSERT: 检查是否显示了"使用场景"部分
4. SCREENSHOT: 基础自动化示例执行结果
5. QUERY: 提取当前页面的标题、主要导航菜单项和主要内容区域的文本
```

**修改后示例：**
```
3. 检查页面是否显示了"使用场景"部分
4. 截取一张当前页面的截图，记录操作结果
5. 提取并显示当前页面的标题、主要导航菜单项和主要内容区域的文本
```

### 4. 执行逻辑增强 (`executor/text_executor.py`)

**新增增强提示词：**
```python
enhanced_prompt = f"""{prompt}

请根据上述自然语言描述，自动判断需要执行什么操作：
- 如果是导航，使用导航工具
- 如果是点击、输入、滚动等交互，使用相应的交互工具
- 如果是查询、验证信息，使用查询工具
- 如果需要截图，使用截图工具
- 如果是其他操作，选择最合适的工具

请自动完成这个任务，并告诉我执行结果。"""
```

## 优势

1. **更直观的语法**：用户无需学习特殊指令，直接用自然语言描述即可
2. **更高的可读性**：测试用例更像文档，易于理解和维护
3. **更好的灵活性**：AI 自动判断操作类型，支持更多场景
4. **更简洁的代码**：减少解析逻辑，降低维护成本
5. **更好的扩展性**：未来添加新功能时无需修改解析器

## 使用示例

### 旧的指令式写法（已弃用）：
```txt
1. 导航到页面并等待完全加载
2. 点击左侧导航菜单中的"MCP 服务"菜单项
3. ASSERT: 检查是否显示了"使用场景"部分
4. SCREENSHOT: 基础自动化示例执行结果
5. QUERY: 提取当前页面的标题、主要导航菜单项和主要内容区域的文本
```

### 新的自然语言写法：
```txt
1. 导航到页面并等待完全加载
2. 点击左侧导航菜单中的"MCP 服务"菜单项
3. 检查页面是否显示了"使用场景"部分
4. 截取一张当前页面的截图，记录操作结果
5. 提取并显示当前页面的标题、主要导航菜单项和主要内容区域的文本
```

## 向后兼容性

- 旧的指令式格式仍然可以工作（因为所有内容都被当作自然语言处理）
- 但建议使用新的自然语言格式，获得更好的可读性和灵活性

## 测试

所有测试用例已更新为新的自然语言格式：
- `basic_usage.txt` - 基础使用示例
- `baidu_query_demo.txt` - 百度查询演示
- `github_interaction.txt` - GitHub 交互演示
- `search_results_demo.txt` - 搜索结果提取演示
- `httpbin_interaction.txt` - HTTPBin 交互演示

## 总结

这次重构让自然语言模式更加用户友好，降低了学习成本，提高了可维护性。用户现在可以直接用自然语言描述他们想要的操作，而无需学习特殊指令格式。AI 大模型会自动理解用户的意图并选择合适的工具执行相应的操作。
